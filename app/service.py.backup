import os
import random
from typing import Any, Dict, List, Optional

from openai import OpenAI

from .prompts import get_agent_system_prompt


class AgentService:
    def __init__(self, openai_api_key: Optional[str] = None, model: Optional[str] = None) -> None:
        mock_env = os.getenv("AGENT_MOCK", "").strip().lower()
        self.mock: bool = mock_env in {"1", "true", "yes", "on"}

        api_key = openai_api_key or os.getenv("OPENAI_API_KEY")
        if not api_key:
            # If no key is provided and mock is not explicitly disabled, enable mock mode
            if not self.mock:
                self.mock = True
        if not self.mock:
            try:
                self.client = OpenAI(api_key=api_key)
                print(f"SERVICE DEBUG: OpenAI client initialized successfully")
            except Exception as e:
                print(f"SERVICE DEBUG: Failed to initialize OpenAI client: {e}")
                self.mock = True
        else:
            self.client = None  # type: ignore
        self.model = model or os.getenv("OPENAI_MODEL", "gpt-4o-mini")

    def chat(self, user_message: str, context_messages: Optional[List[Dict[str, str]]] = None, elevenlabs_extra_body: Optional[Dict[str, Any]] = None) -> str:
        if self.mock:
            return self._get_mock_response(user_message)
        
        try:
            messages: List[Dict[str, str]] = [
                {"role": "system", "content": get_agent_system_prompt()},
            ]
            if context_messages:
                messages.extend(context_messages)
            messages.append({"role": "user", "content": user_message})

            # Log ElevenLabs extra body for debugging
            if elevenlabs_extra_body:
                print(f"SERVICE DEBUG: ElevenLabs extra body: {elevenlabs_extra_body}")

            response = self.client.chat.completions.create(  # type: ignore
                model=self.model,
                messages=messages,
                temperature=0.3,
                max_tokens=500,  # Limit tokens for faster response
            )
            content = response.choices[0].message.content if response.choices else ""
            return content or self._get_fallback_response(user_message)
            
        except Exception as e:
            print(f"SERVICE DEBUG: OpenAI API error: {e}")
            return self._get_fallback_response(user_message)

    def _get_fallback_response(self, user_message: str) -> str:
        """Fallback response when OpenAI API fails"""
        message_lower = user_message.lower()
        
        if any(word in message_lower for word in ["rent", "rental", "renting"]):
            return "I can help you with car rentals. What type of vehicle are you looking for and what dates do you need it?"
        elif any(word in message_lower for word in ["buy", "purchase", "buying"]):
            return "I'd be happy to help you find a car to purchase. What's your budget range and what type of vehicle interests you?"
        else:
            return "Hi! I'm Alex from MyCarCar. I can help you with car rentals and sales. How can I assist you today?"

    def _get_mock_response(self, user_message: str) -> str:
        """Generate contextual mock responses based on user input"""
        message_lower = user_message.lower()
        
        # Car brand specific responses
        if "audi" in message_lower:
            return (
                "Audi offers a smooth drive, premium interiors, and strong safety features. "
                "For rentals we can check options like compact sedans or sporty SUVs. "
                "Pricing varies by city, dates, and coverage; I can check availability now if you share dates and pickup location."
            )
        elif "bmw" in message_lower:
            return (
                "BMW provides excellent performance and luxury features. "
                "We have various models available for rental from sporty coupes to spacious SUVs. "
                "What dates and location are you considering for your rental?"
            )
        elif "mercedes" in message_lower or "benz" in message_lower:
            return (
                "Mercedes-Benz offers premium comfort and advanced technology. "
                "Our fleet includes sedans, SUVs, and luxury vehicles. "
                "Could you tell me your preferred dates and pickup location?"
            )
        elif "toyota" in message_lower:
            return (
                "Toyota vehicles are known for reliability and fuel efficiency. "
                "We have options from compact cars to family SUVs. "
                "What type of vehicle and rental period are you looking for?"
            )
        
        # Intent-based responses
        elif any(word in message_lower for word in ["rent", "rental", "renting"]):
            return (
                "Great! I can help you find the perfect rental car. "
                "What type of vehicle are you looking for and what dates do you need it? "
                "Also, which city will you be picking up from?"
            )
        elif any(word in message_lower for word in ["buy", "purchase", "buying"]):
            return (
                "I'd be happy to help you find a car to purchase! "
                "What's your budget range and what type of vehicle interests you? "
                "Are you looking for new or pre-owned options?"
            )
        elif any(word in message_lower for word in ["price", "cost", "how much"]):
            return (
                "Pricing depends on several factors like vehicle type, rental duration, and location. "
                "For rentals, we typically start around fifty dollars per day for economy cars. "
                "Could you share more details about what you're looking for?"
            )
        elif any(word in message_lower for word in ["available", "availability"]):
            return (
                "I can check availability for you right away! "
                "Just let me know your preferred dates, pickup location, and vehicle type. "
                "I'll find the best options available for your needs."
            )
        elif any(word in message_lower for word in ["book", "booking", "reserve"]):
            return (
                "Perfect! I can help you make a booking. "
                "I'll need your rental dates, pickup location, and vehicle preference. "
                "Do you have any specific requirements or preferences?"
            )
        
        # Greeting responses
        elif any(word in message_lower for word in ["hello", "hi", "hey"]):
            greetings = [
                "Hi there! I'm Alex from MyCarCar. How can I help you today?",
                "Hello! I'm here to assist with car rentals and sales. What can I do for you?",
                "Hi! Welcome to MyCarCar. Are you looking to rent a car or explore our sales options?"
            ]
            return random.choice(greetings)
        
        # Default contextual response
        else:
            responses = [
                "I'm Alex from MyCarCar and I can help with rentals or car sales. Tell me what you're looking for and your city and dates if renting. I'll find clear options and next steps for you.",
                "Hi! I can assist you with car rentals or purchases. What type of vehicle are you interested in and when do you need it?",
                "Hello! I'm here to help you find the perfect car. Are you looking to rent for a trip or buy a vehicle? Let me know your preferences and I'll guide you through the options."
            ]
            return random.choice(responses)
